<!doctype html>
<head>
    <meta charset="utf-8">

    <title>My Profile</title>
    <meta name="description" content="My Parse App">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/bootstrap.min.css">
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="parse-1.2.12.min.js"></script>
	  <script src="js/bootstrap.min.js"></script>
    <script type="text/javascript">
        Parse.initialize("3tHHUyxjtuSEiHranjliYJkJ36fEO89Ql77L2jng", "nY2YCI6Jn6ikyBWrjOxf3zj5bc8aPL5gvIUgGC5C");
    </script>
</head>

<body>
<div class="nav">
	<ul class="nav nav-tabs">
	  <li><a href="index.html">Home</a></li>
	  <li class="active"><a href="#">Profile</a></li>
	  <li><a href="leaderboard.html">Leaderboard</a></li>
	</ul>
  </div>
  <div id="fb-root"></div>
<!--   <button onclick="window.location.href='index.html'">Home</button> -->
  <div id="main">
    <h1>Meow Profile!</h1>

    <div style="display:none" class="error">
      Looks like there was a problem saving the test object. Make sure you've set your application ID and javascript key correctly in the call to <code>Parse.initialize</code> in this file.
    </div>

    <div style="display:none" class="empty">
        <h3><b>Please upload your 3 choices of the day.</b></h3>
	    <p>
        <b>Link 1 : </b><input id="link1"></input><br>
        <b>Link 2 : </b><input id="link2"></input><br>
        <b>Link 3 : </b><input id="link3"></input><br>
        </P>
        <button onclick="submitLinks()">Submit</button>
    </div>

    <div style="display:none" class="picture">
        <p><b>These are your 3 image choices of the day.</b></p>
        <div style="height: 200px" id="scores">
            <img style="max-height: 100%; max-width: 100%" id="img1"></img>
            <img style="max-height: 100%; max-width: 100%" id="img2"></img>
            <img style="max-height: 100%; max-width: 100%" id="img3"></img>
        </div>
  </div>

  <script type="text/javascript">
    function countLink() {
        var Pictures = Parse.Object.extend("Pictures");
        var pics = new Parse.Query(Pictures);

        pics.equalTo("owner", Parse.User.current());
        pics.count({
          success: function(count) {
            // The count request succeeded. Show the count
            if (count == 0) {
                $(".empty").show();
            } else {
                pics.find({
                    success: function(results) {
                        // Do something with the returned Parse.Object values
                        $('#scores').append("<table><tr>");
                        for (var i = 0; i < results.length; i++) { 
                            var object = results[i];
                            $('#img'+(i+1)).attr('src',object.get('URL'));
                            $('#scores').append("<td width=\"300px\">up: " + object.get('rating') + " total view: " + object.get('totalViews') + "</td>");
                        }
                        $('#scores').append("</tr></table>");
                        $(".picture").show();
                    },
                        error: function(error) {
                        alert("Error: " + error.code + " " + error.message);
                    }
                });
            }
          },
          error: function(error) {
            // The request failed
          }
        });
    }

    function checkURL(url) {
        //var txt='http://d24w6bsrhbeh9d.cloudfront.net/photo/aWZYnEZ_460s.jpg';

        var re1='((?:http|https)(?::\\/{2}[\\w]+)(?:[\\/|\\.]?)(?:[^\\s"]*))';	// HTTP URL 1

        var p = new RegExp(re1,["i"]);
        var m = p.exec(url);
        if (m != null && url.match(/\.(jpeg|jpg|gif|png)$/) != null) {
            return 0;
        }
        return 1;
    }

    function isLoggedIn() {
        var currentUser = Parse.User.current();
        if (currentUser) {
            // do stuff with the user
            countLink();
        } else {
//countLink();
            // show the signup or login page
            window.location.href = "index.html";
        }
    }

    window.onload = isLoggedIn;

    function submitLinks(){
        var Pictures = Parse.Object.extend("Pictures");
        var pic1 = new Pictures();
        var pic2 = new Pictures();
        var pic3 = new Pictures();

        if ($('#link1').val() == "" || $('#link2').val() == "" || $('#link3').val() == "" || checkURL($('#link1').val()) || checkURL($('#link2').val()) || checkURL($('#link3').val())) {
            alert("You must input valid links for image!");
        } else {
            pic1.save({
                URL: $('#link1').val(),
                owner: Parse.User.current(),
                type: "cat"
              }, {
                success: function(object) {
              },
                error: function(model, error) {
                $(".error").show();
              }
            });
            pic2.save({
                URL: $('#link2').val(),
                owner: Parse.User.current(),
                type: "cat"
              }, {
                success: function(object) {
              },
                error: function(model, error) {
                $(".error").show();
              }
            });
            pic3.save({
                URL: $('#link3').val(),
                owner: Parse.User.current(),
                type: "cat"
              }, {
                success: function(object) {
              },
                error: function(model, error) {
                $(".error").show();
              }
            });
            $(".empty").hide();
            $("#main").append("<b>Successfully uploaded your choices.</b>");
        }
    }
  </script>
</body>

</html>
